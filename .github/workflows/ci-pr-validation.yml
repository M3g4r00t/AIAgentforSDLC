name: CI - PR Validation

on:
  pull_request:
    branches: [ "master", "develop" ]

jobs:
  # ─── 1. Backend Tests ──────────────────────────────
  test-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install Dependencies
        run: npm ci
        working-directory: src/backend
      - name: Run Unit Tests
        run: npm test
        working-directory: src/backend

  # ─── 2. Frontend Validation ────────────────────────
  test-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install Dependencies
        run: npm ci
        working-directory: src/frontend
      - name: Lint Check
        run: npm run lint
        working-directory: src/frontend
      - name: Build Check
        run: npm run build
        working-directory: src/frontend

  # ─── 3. E2E Tests (Playwright) ─────────────────────
  test-e2e:
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      # Install & Start Backend
      - name: Install Backend
        run: npm ci
        working-directory: src/backend
      - name: Start Backend
        run: node src/backend/index.js &
        env:
          PORT: 4000
          
      # Install & Start Frontend
      - name: Install Frontend
        run: npm ci
        working-directory: src/frontend
      - name: Start Frontend
        run: npm run dev &
        working-directory: src/frontend
        env:
          NEXT_PUBLIC_API_URL: http://localhost:4000

      # Wait for services
      - name: Wait for servers
        run: npx wait-on http://localhost:4000 http://localhost:3000 --timeout 30000

      # Run Playwright
      - name: Install Playwright
        run: npx playwright install --with-deps chromium
        working-directory: tests
      - name: Run E2E Tests
        run: npx playwright test --project=chromium
        working-directory: tests
        env:
           # Retry on PRs to avoid flakes
           CI: true 
