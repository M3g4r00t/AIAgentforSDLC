name: CD - QA Environment

on:
  push:
    branches: [ "develop" ]

env:
  IBM_CLOUD_REGION: us-south
  CE_PROJECT: ibm-consulting-project
  REGISTRY: us.icr.io
  NAMESPACE: ibm-consulting

jobs:
  build-and-deploy-qa:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # ─── Docker Build & Push ──────────────────────
      - name: Login to IBM Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: iamapikey
          password: ${{ secrets.IBM_CLOUD_API_KEY }}

      - name: Build & Push Backend (QA)
        uses: docker/build-push-action@v5
        with:
          context: src/backend
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/ibm-consulting-api:qa-latest

      - name: Build & Push Frontend (QA)
        uses: docker/build-push-action@v5
        with:
          context: src/frontend
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/ibm-consulting-web:qa-latest

      # ─── Deploy to Code Engine (QA Apps) ──────────
      - name: Install IBM Cloud CLI
        run: |
          curl -fsSL https://clis.cloud.ibm.com/install/linux | sh
          ibmcloud plugin install code-engine -f

      - name: Authenticate IBM Cloud
        run: |
          ibmcloud login --apikey ${{ secrets.IBM_CLOUD_API_KEY }} -r ${{ env.IBM_CLOUD_REGION }}
          ibmcloud target -g Default
          ibmcloud ce project select --name ${{ env.CE_PROJECT }}

      - name: Ensure Registry Secret Exists
        run: |
          if ! ibmcloud ce registry get --name ibm-consulting-secret > /dev/null 2>&1; then
            echo "Creating registry secret..."
            ibmcloud ce registry create \
              --name ibm-consulting-secret \
              --server ${{ env.REGISTRY }} \
              --username iamapikey \
              --password ${{ secrets.IBM_CLOUD_API_KEY }}
          else
            echo "Registry secret already exists."
          fi

      - name: Deploy Backend QA
        run: |
          if ibmcloud ce app get --name ibm-consulting-api-qa > /dev/null 2>&1; then
            echo "App exists, updating..."
            ibmcloud ce app update \
              --name ibm-consulting-api-qa \
              --image ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/ibm-consulting-api:qa-latest
          else
            echo "App does not exist, creating..."
            ibmcloud ce app create \
              --name ibm-consulting-api-qa \
              --image ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/ibm-consulting-api:qa-latest \
              --min-scale 1 \
              --registry-secret ibm-consulting-secret
          fi

      - name: Deploy Frontend QA
        run: |
          API_URL="https://ibm-consulting-api-qa.26dwjxqdfb88.us-south.codeengine.appdomain.cloud"
          if ibmcloud ce app get --name ibm-consulting-web-qa > /dev/null 2>&1; then
            echo "App exists, updating..."
            ibmcloud ce app update \
              --name ibm-consulting-web-qa \
              --image ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/ibm-consulting-web:qa-latest \
              --env NEXT_PUBLIC_API_URL=$API_URL
          else
            echo "App does not exist, creating..."
            ibmcloud ce app create \
              --name ibm-consulting-web-qa \
              --image ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/ibm-consulting-web:qa-latest \
              --min-scale 1 \
              --registry-secret ibm-consulting-secret \
              --env NEXT_PUBLIC_API_URL=$API_URL
          fi
